name: Build / Openterface Windows Portable (Static)

on:
  push:
    branches: [ main, "dev_1223_portable_build" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MINGW_ROOT: C:\\mingw64
  QT_PREFIX: C:\\Qt6
  FFMPEG_PREFIX: C:\\ffmpeg-static
  SOURCE_DIR: D:\\a\\openterface\\openterface

jobs:
  setup-env:
    name: Setup Build Environment
    runs-on: windows-2022
    outputs:
      qt-cache-hit: ${{ steps.cache-qt.outputs.cache-hit }}
      ffmpeg-cache-hit: ${{ steps.cache-ffmpeg.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup MSYS2
        id: setup-msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-bzip2
            mingw-w64-x86_64-xz
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libmfx
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libiconv
            diffutils
            make
            libtool
            git
            perl

      - name: Set MINGW_ROOT
        run: echo "MINGW_ROOT=${{ steps.setup-msys2.outputs.msys2-location }}/mingw64" >> $GITHUB_ENV

      - name: Set OPENSSL_ROOT
        run: echo "OPENSSL_ROOT=${{ env.MINGW_ROOT }}" >> $GITHUB_ENV


      - name: Cache Qt static build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_PREFIX }}
          key: qt-6.6.3-msys2-mingw64-windows-static-${{ hashFiles('build-script/build-static-qt-from-source.sh') }}

      - name: Cache FFmpeg static build
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: ${{ env.FFMPEG_PREFIX }}
          key: ffmpeg-static-msys2-mingw64-windows-${{ hashFiles('build-script/build-static-ffmpeg-windows.sh') }}

  build-qt:
    name: Build Qt 6.6.3 (Static)
    needs: setup-env
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Qt cache status
        id: check-qt-cache
        run: echo "cache-hit=${{ needs.setup-env.outputs.qt-cache-hit }}" >> $GITHUB_OUTPUT

      - name: Setup MSYS2
        if: steps.check-qt-cache.outputs.cache-hit == 'false'
        id: setup-msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-bzip2
            mingw-w64-x86_64-xz
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libmfx
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libiconv
            mingw-w64-x86_64-lld
            diffutils
            make
            libtool
            git
            perl

      - name: Set MINGW_ROOT
        if: steps.check-qt-cache.outputs.cache-hit == 'false'
        run: echo "MINGW_ROOT=${{ steps.setup-msys2.outputs.msys2-location }}/mingw64" >> $GITHUB_ENV

      - name: Set OPENSSL_ROOT
        if: steps.check-qt-cache.outputs.cache-hit == 'false'
        run: echo "OPENSSL_ROOT=${{ env.MINGW_ROOT }}" >> $GITHUB_ENV

      - name: Build Qt statically from source
        if: steps.check-qt-cache.outputs.cache-hit == 'false'
        shell: msys2 {0}
        run: |
          ./build-script/build-static-qt-from-source.sh
        env:
          MINGW_ROOT: ${{ env.MINGW_ROOT }}
          QT_PREFIX: ${{ env.QT_PREFIX }}
          EXTERNAL_MINGW: ${{ env.MINGW_ROOT }}
          OPENSSL_ROOT: ${{ env.OPENSSL_ROOT }}

      - name: Upload Qt artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-static
          path: ${{ env.QT_PREFIX }}
          retention-days: 1

      - name: Save Qt cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.QT_PREFIX }}
          key: qt-6.6.3-msys2-mingw64-windows-static-${{ hashFiles('build-script/build-static-qt-from-source.sh') }}

  build-ffmpeg:
    name: Build FFmpeg (Static)
    needs: setup-env
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check FFmpeg cache status
        id: check-ffmpeg-cache
        run: echo "cache-hit=${{ needs.setup-env.outputs.ffmpeg-cache-hit }}" >> $GITHUB_OUTPUT

      - name: Setup MSYS2
        if: steps.check-ffmpeg-cache.outputs.cache-hit == 'false'
        id: setup-msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-bzip2
            mingw-w64-x86_64-xz
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libmfx
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libiconv
            diffutils
            make
            libtool
            git
            perl

      - name: Set MINGW_ROOT
        if: steps.check-ffmpeg-cache.outputs.cache-hit == 'false'
        run: echo "MINGW_ROOT=${{ steps.setup-msys2.outputs.msys2-location }}/mingw64" >> $GITHUB_ENV

      - name: Set OPENSSL_ROOT
        if: steps.check-ffmpeg-cache.outputs.cache-hit == 'false'
        run: echo "OPENSSL_ROOT=${{ env.MINGW_ROOT }}" >> $GITHUB_ENV

      - name: Build FFmpeg statically
        if: steps.check-ffmpeg-cache.outputs.cache-hit == 'false'
        shell: msys2 {0}
        run: |
          ./build-script/build-static-ffmpeg-windows.sh
        env:
          MINGW_ROOT: ${{ env.MINGW_ROOT }}
          FFMPEG_PREFIX: ${{ env.FFMPEG_PREFIX }}
          EXTERNAL_MINGW_POSIX: /mingw64
          SKIP_PACKAGE_MINGW: 1

      - name: Upload FFmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-static
          path: ${{ env.FFMPEG_PREFIX }}
          retention-days: 1

      - name: Save FFmpeg cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.FFMPEG_PREFIX }}
          key: ffmpeg-static-msys2-mingw64-windows-${{ hashFiles('build-script/build-static-ffmpeg-windows.sh') }}

  build-project:
    name: Build Main Project (Static & Portable)
    needs: [setup-env, build-qt, build-ffmpeg]
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        id: setup-msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: |
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-bzip2
            mingw-w64-x86_64-xz
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libmfx
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libiconv
            diffutils
            make
            libtool
            git
            perl

      - name: Set MINGW_ROOT
        run: echo "MINGW_ROOT=${{ steps.setup-msys2.outputs.msys2-location }}/mingw64" >> $GITHUB_ENV

      - name: Set OPENSSL_ROOT
        run: echo "OPENSSL_ROOT=${{ env.MINGW_ROOT }}" >> $GITHUB_ENV

      - name: Download Qt artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: qt-static
          path: C:\
          if-no-files-found: warn

      - name: Check Qt artifact presence
        id: check-qt-artifact
        run: |
          if (Test-Path "${{ env.QT_PREFIX }}") { echo "qt-artifact-present=true" >> $GITHUB_OUTPUT } else { echo "qt-artifact-present=false" >> $GITHUB_OUTPUT }

      - name: Restore Qt cache (if artifact missing)
        if: steps.check-qt-artifact.outputs.qt-artifact-present == 'false'
        id: restore-qt
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_PREFIX }}
          key: qt-6.6.3-msys2-mingw64-windows-static-${{ hashFiles('build-script/build-static-qt-from-source.sh') }}

      - name: Show Qt cache restore result
        if: steps.check-qt-artifact.outputs.qt-artifact-present == 'false'
        run: |
          echo "qt-cache-hit=${{ steps.restore-qt.outputs.cache-hit }}"

      - name: List Qt directory (PowerShell debug)
        run: |
          echo "QT_PREFIX=${{ env.QT_PREFIX }}"
          if (Test-Path "${{ env.QT_PREFIX }}") { dir "${{ env.QT_PREFIX }}" } else { echo "${{ env.QT_PREFIX }} not found" }

      - name: Download FFmpeg artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ffmpeg-static
          path: C:\
          if-no-files-found: warn

      - name: Check FFmpeg artifact presence
        id: check-ffmpeg-artifact
        run: |
          if (Test-Path "${{ env.FFMPEG_PREFIX }}") { echo "ffmpeg-artifact-present=true" >> $GITHUB_OUTPUT } else { echo "ffmpeg-artifact-present=false" >> $GITHUB_OUTPUT }

      - name: Restore FFmpeg cache (if artifact missing)
        if: steps.check-ffmpeg-artifact.outputs.ffmpeg-artifact-present == 'false'
        id: restore-ffmpeg
        uses: actions/cache@v4
        with:
          path: ${{ env.FFMPEG_PREFIX }}
          key: ffmpeg-static-msys2-mingw64-windows-${{ hashFiles('build-script/build-static-ffmpeg-windows.sh') }}

      - name: Show FFmpeg cache restore result
        if: steps.check-ffmpeg-artifact.outputs.ffmpeg-artifact-present == 'false'
        run: |
          echo "ffmpeg-cache-hit=${{ steps.restore-ffmpeg.outputs.cache-hit }}"

      - name: List FFmpeg directory (PowerShell debug)
        run: |
          echo "FFMPEG_PREFIX=${{ env.FFMPEG_PREFIX }}"
          if (Test-Path "${{ env.FFMPEG_PREFIX }}") { dir "${{ env.FFMPEG_PREFIX }}" } else { echo "${{ env.FFMPEG_PREFIX }} not found" }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: List Qt/FFmpeg in msys2 (debug)
        shell: msys2 {0}
        run: |
          echo "Listing /c/Qt6 and /c/ffmpeg-static"
          ls /c/Qt6 || echo "/c/Qt6 not found"
          ls /c/ffmpeg-static || echo "/c/ffmpeg-static not found"

      - name: Configure CMake (Static Build)
        shell: msys2 {0}
        run: |
          mkdir build && cd build
          cmake .. \
            -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/c/Qt6;/c/ffmpeg-static" \
            -DBUILD_SHARED_LIBS=OFF \
            -DSTATIC_LINKAGE=ON
        env:
          CC: gcc
          CXX: g++

      - name: Build project
        shell: msys2 {0}
        run: |
          cd build
          mingw32-make -j$(nproc)

      - name: Verify static linking (no DLL dependencies)
        shell: powershell
        run: |
          $exe = "build\Release\openterfaceQT-portable.exe"  
          if (-not (Test-Path $exe)) {
            $exe = "build\openterfaceQT-portable.exe"  # Debug or no subfolder
          }
          if (-not (Test-Path $exe)) {
            throw "Executable not found!"
          }
          $deps = objdump -p $exe | Select-String "\.dll"
          if ($deps) {
            Write-Error "Detected DLL dependencies! Not fully static:"
            $deps
            exit 1
          } else {
            Write-Host "✅ No DLL dependencies — fully static!"
          }

      - name: Upload final portable executable
        uses: actions/upload-artifact@v4
        with:
          name: openterface-windows-portable
          path: build/*.exe