name: Build / Openterface Windows Portable (Static)

on:
  push:
    branches: [ main, "dev_1223_portable_build" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MINGW_ROOT: C:\\mingw64
  QT_PREFIX: C:\\Qt6
  FFMPEG_PREFIX: C:\\ffmpeg-static
  VCPKG_ROOT: C:\\vcpkg
  SOURCE_DIR: D:\\a\\openterface\\openterface

jobs:
  setup-env:
    name: Setup Build Environment
    runs-on: windows-2022
    outputs:
      qt-cache-hit: ${{ steps.cache-qt.outputs.cache-hit }}
      ffmpeg-cache-hit: ${{ steps.cache-ffmpeg.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download and Install MinGW-w64 (x86_64, SEH, POSIX, 11.2.0)
        shell: powershell
        run: |
          $url = "https://github.com/cristianadam/mingw-builds/releases/download/v11.2.0-rev3/x86_64-11.2.0-release-posix-seh-rt_v9-rev3.7z"
          $out = "${{ runner.temp }}/mingw64.7z"
          Write-Host "Downloading MinGW-w64 from $url..."
          Invoke-WebRequest -Uri $url -OutFile $out
          7z x $out -o"C:\" -y
          if (-not (Test-Path "${{ env.MINGW_ROOT }}")) {
            throw "MinGW not found at ${{ env.MINGW_ROOT }}"
          }
          echo "MINGW_ROOT=${{ env.MINGW_ROOT }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Add MinGW to PATH
        run: echo "${{ env.MINGW_ROOT }}\bin" >> $GITHUB_PATH

      - name: Install NASM (required by FFmpeg)
        shell: powershell
        run: |
          $env:chocolateyInstallRefreshEnv = 'false'
          choco install nasm -y

      - name: Bootstrap vcpkg
        shell: cmd
        run: |
          if not exist "${{ env.VCPKG_ROOT }}\.git" (
            git clone https://github.com/microsoft/vcpkg.git "${{ env.VCPKG_ROOT }}"
          ) else (
            cd "${{ env.VCPKG_ROOT }}"
            git fetch --all --tags
            git reset --hard origin/HEAD
          )
          "${{ env.VCPKG_ROOT }}\bootstrap-vcpkg.bat"

      - name: Cache vcpkg installed packages
        id: cache-vcpkg-installed
        uses: actions/cache@v4
        with:
          path: ${{ env.VCPKG_ROOT }}/installed
          key: vcpkg-installed-windows-static-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-installed-windows-static-

      - name: Cache Qt static build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ env.QT_PREFIX }}
          key: qt-6.6.3-mingw-11.2.0-posix-windows-static-${{ hashFiles('build-script/build-static-qt-from-source.bat') }}

      - name: Cache FFmpeg static build
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: ${{ env.FFMPEG_PREFIX }}
          key: ffmpeg-static-mingw-11.2.0-posix-windows-${{ hashFiles('build-script/build-static-ffmpeg-windows.bat') }}

      - name: Upload MinGW + vcpkg as artifact (for other jobs)
        uses: actions/upload-artifact@v4
        with:
          name: build-environment
          path: |
            ${{ env.MINGW_ROOT }}
          retention-days: 1

  build-qt:
    name: Build Qt 6.6.3 (Static)
    needs: setup-env
    runs-on: windows-2022
    if: ${{ needs.setup-env.outputs.qt-cache-hit != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build environment
        uses: actions/download-artifact@v4
        with:
          name: build-environment
          path: C:\

      - name: Setup vcpkg
        shell: cmd
        run: |
          if not exist "${{ env.VCPKG_ROOT }}\.git" (
            git clone https://github.com/microsoft/vcpkg.git "${{ env.VCPKG_ROOT }}"
          ) else (
            cd "${{ env.VCPKG_ROOT }}"
            git fetch --all --tags
            git reset --hard origin/HEAD
          )
          if not exist "${{ env.VCPKG_ROOT }}\vcpkg.exe" (
            "${{ env.VCPKG_ROOT }}\bootstrap-vcpkg.bat"
          )

      - name: Add MinGW to PATH
        run: echo "${{ env.MINGW_ROOT }}\bin" >> $GITHUB_PATH

      - name: Build Qt statically from source
        shell: cmd
        run: |
          set VCPKG_ROOT=${{ env.VCPKG_ROOT }}
          call "build-script\build-static-qt-from-source.bat" "${{ env.SOURCE_DIR }}"
        env:
          MINGW_ROOT: ${{ env.MINGW_ROOT }}
          QT_PREFIX: ${{ env.QT_PREFIX }}

      - name: Upload Qt artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-static
          path: ${{ env.QT_PREFIX }}
          retention-days: 1

  build-ffmpeg:
    name: Build FFmpeg (Static)
    needs: setup-env
    runs-on: windows-2022
    if: ${{ needs.setup-env.outputs.ffmpeg-cache-hit != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build environment
        uses: actions/download-artifact@v4
        with:
          name: build-environment
          path: C:\

      - name: Install NASM (required by FFmpeg)
        shell: powershell
        run: |
          $env:chocolateyInstallRefreshEnv = 'false'
          choco install nasm -y

      - name: Add MinGW to PATH
        run: echo "${{ env.MINGW_ROOT }}\bin" >> $GITHUB_PATH

      - name: Build FFmpeg statically
        shell: cmd
        run: |
          call "build-script\build-static-ffmpeg-windows.bat"
        env:
          MINGW_ROOT: ${{ env.MINGW_ROOT }}
          FFMPEG_PREFIX: ${{ env.FFMPEG_PREFIX }}

      - name: Upload FFmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-static
          path: ${{ env.FFMPEG_PREFIX }}
          retention-days: 1

  build-project:
    name: Build Main Project (Static & Portable)
    needs: [setup-env, build-qt, build-ffmpeg]
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build environment
        uses: actions/download-artifact@v4
        with:
          name: build-environment
          path: C:\

      - name: Setup vcpkg
        shell: cmd
        run: |
          if not exist "${{ env.VCPKG_ROOT }}\.git" (
            git clone https://github.com/microsoft/vcpkg.git "${{ env.VCPKG_ROOT }}"
          ) else (
            cd "${{ env.VCPKG_ROOT }}"
            git fetch --all --tags
            git reset --hard origin/HEAD
          )
          if not exist "${{ env.VCPKG_ROOT }}\vcpkg.exe" (
            "${{ env.VCPKG_ROOT }}\bootstrap-vcpkg.bat"
          )

      - name: Download Qt artifact
        uses: actions/download-artifact@v4
        with:
          name: qt-static
          path: C:\

      - name: Download FFmpeg artifact
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-static
          path: C:\

      - name: Add MinGW to PATH
        run: echo "${{ env.MINGW_ROOT }}\bin" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure CMake (Static Build)
        shell: cmd
        run: |
          mkdir build && cd build
          cmake .. ^
            -G "MinGW Makefiles" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_PREFIX_PATH="${{ env.QT_PREFIX }};${{ env.FFMPEG_PREFIX }}" ^
            -DVCPKG_ROOT="${{ env.VCPKG_ROOT }}" ^
            -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DSTATIC_LINKAGE=ON
        env:
          CC: gcc
          CXX: g++

      - name: Build project
        shell: cmd
        run: |
          cd build
          mingw32-make -j$(nproc)

      - name: Verify static linking (no DLL dependencies)
        shell: powershell
        run: |
          $exe = "build\Release\openterfaceQT-portable.exe"  
          if (-not (Test-Path $exe)) {
            $exe = "build\openterfaceQT-portable.exe"  # Debug or no subfolder
          }
          if (-not (Test-Path $exe)) {
            throw "Executable not found!"
          }
          $deps = objdump -p $exe | Select-String "\.dll"
          if ($deps) {
            Write-Error "Detected DLL dependencies! Not fully static:"
            $deps
            exit 1
          } else {
            Write-Host "✅ No DLL dependencies — fully static!"
          }

      - name: Upload final portable executable
        uses: actions/upload-artifact@v4
        with:
          name: openterface-windows-portable
          path: build/*.exe