# Build libusb and FFmpeg
ARG BASE_IMAGE=ghcr.io/techxartisanstudio/openterface-qtbuild-setup:ubuntu-22.04-amd64
ARG UBUNTU_VERSION=22.04
ARG TARGETARCH=amd64
FROM ${BASE_IMAGE}

ARG http_proxy 
ARG https_proxy
ENV http_proxy=$http_proxy \
    https_proxy=$https_proxy
    
WORKDIR ${BUILD_DIR}

# Build libusb from source
RUN echo "Building libusb ${LIBUSB_VERSION} from source..." && \
    curl -L -o libusb.tar.bz2 "https://github.com/libusb/libusb/releases/download/v${LIBUSB_VERSION}/libusb-${LIBUSB_VERSION}.tar.bz2" && \
    tar xf libusb.tar.bz2 && \
    mv "libusb-${LIBUSB_VERSION}" libusb && \
    rm libusb.tar.bz2 && \
    cd libusb && \
    ./configure --prefix="${FFMPEG_PREFIX}" --enable-static --enable-shared --disable-udev && \
    make -j$(nproc) && \
    make install && \
    cd ${BUILD_DIR} && \
    rm -rf libusb

# Build libjpeg-turbo from source
RUN echo "Building libjpeg-turbo from source..." && \
    curl -L -o libjpeg-turbo.tar.gz "https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/3.0.4.tar.gz" && \
    tar xzf libjpeg-turbo.tar.gz && \
    rm libjpeg-turbo.tar.gz && \
    cd libjpeg-turbo-3.0.4 && \
    mkdir build && \
    cd build && \
    cmake .. \
        -DCMAKE_INSTALL_PREFIX="${FFMPEG_PREFIX}" \
        -DCMAKE_BUILD_TYPE=Release \
        -DENABLE_STATIC=ON \
        -DENABLE_SHARED=ON \
        -DWITH_JPEG8=ON \
        -DWITH_TURBOJPEG=ON && \
    make -j$(nproc) && \
    make install && \
    cd ${BUILD_DIR} && \
    rm -rf libjpeg-turbo-3.0.4

# Build FFmpeg with both shared and static libs and hardware acceleration support
RUN echo "Building FFmpeg ${FFMPEG_VERSION} with hardware acceleration (Intel QSV, NVIDIA NVDEC/CUDA)..." && \
    curl -L -o ffmpeg.tar.bz2 "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.bz2" && \
    tar xjf ffmpeg.tar.bz2 && \
    rm ffmpeg.tar.bz2 && \
    cd "ffmpeg-${FFMPEG_VERSION}" && \
    ./configure \
        --prefix="${FFMPEG_PREFIX}" \
        --enable-static \
        --enable-shared \
        --disable-doc \
        --disable-programs \
        --disable-outdevs \
        --enable-pic \
        --enable-libpulse \
        --disable-debug \
        --enable-gpl \
        --enable-nonfree \
        --enable-hwaccels \
        --enable-libmfx \
        --enable-nvenc \
        --enable-nvdec \
        --enable-cuda \
        --enable-cuvid \
        --enable-decoder=mjpeg \
        --enable-decoder=mjpeg_qsv \
        --enable-decoder=mjpeg_cuvid \
        --extra-cflags="-I/usr/local/cuda/include" \
        --extra-ldflags="-L/usr/local/cuda/lib64" && \
    make -j$(nproc) && \
    make install && \
    cd ${BUILD_DIR} && \
    rm -rf "ffmpeg-${FFMPEG_VERSION}"

# Verify FFmpeg installation
RUN echo "Verifying FFmpeg installation..." && \
    ls -la ${FFMPEG_PREFIX}/lib/libav*.a && \
    ls -la ${FFMPEG_PREFIX}/include/libav*/

WORKDIR /workspace
